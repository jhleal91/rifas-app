import React, { useState, useEffect } from 'react';
import { useParams, Link } from 'react-router-dom';
import QRCode from 'qrcode';

const RifaManagement = ({ rifas, setRifas }) => {
  const { id } = useParams();
  const [rifa, setRifa] = useState(null);
  const [qrCode, setQrCode] = useState('');
  const [nuevoParticipante, setNuevoParticipante] = useState({
    nombre: '',
    telefono: '',
    numeros: []
  });
  const [numerosSeleccionados, setNumerosSeleccionados] = useState([]);
  const [mostrarModalVenta, setMostrarModalVenta] = useState(false);
  const [tipoVenta, setTipoVenta] = useState('individual'); // 'individual' o 'multiple'
  const [participantesVenta, setParticipantesVenta] = useState([]);
  const [mismoNombre, setMismoNombre] = useState(false);

  // Funci√≥n para obtener elementos disponibles basado en la estructura del backend
  const obtenerElementosDisponibles = (rifa) => {
    if (!rifa) return [];
    
    // Si tiene elementos_personalizados, usarlos
    if (rifa.elementos_personalizados && Array.isArray(rifa.elementos_personalizados)) {
      return rifa.elementos_personalizados;
    }
    
    // Si es tipo numeros y no tiene elementos_personalizados, generar n√∫meros
    if (rifa.tipo === 'numeros') {
      const cantidad = rifa.cantidad_elementos || 100;
      return Array.from({ length: cantidad }, (_, i) => (i + 1).toString());
    }
    
    // Fallback: array vac√≠o
    return [];
  };

  useEffect(() => {
    if (id) {
      // Cargar datos completos desde el backend
      cargarDatosRifa();
    }
  }, [id]);

  // Efecto separado para generar QR cuando la rifa est√© cargada
  useEffect(() => {
    if (rifa && rifa.id) {
      generarQR(rifa.id);
    }
  }, [rifa]);

  const generarQR = async (rifaId) => {
    try {
      const url = `${window.location.origin}/public/${rifaId}`;
      const qrCodeDataURL = await QRCode.toDataURL(url, {
        width: 200,
        margin: 2,
        color: {
          dark: '#000000',
          light: '#FFFFFF'
        }
      });
      setQrCode(qrCodeDataURL);
    } catch (err) {
      console.error('Error generando QR:', err);
    }
  };

  const seleccionarNumero = (numero) => {
    if (numerosSeleccionados.includes(numero)) {
      setNumerosSeleccionados(numerosSeleccionados.filter(n => n !== numero));
    } else {
      setNumerosSeleccionados([...numerosSeleccionados, numero]);
    }
  };

  const venderNumeros = () => {
    if (numerosSeleccionados.length === 0) {
      alert('Por favor, selecciona al menos un n√∫mero para vender.');
      return;
    }
    
    // Si hay datos en los campos, hacer venta directa
    if (nuevoParticipante.nombre.trim()) {
      venderDirecto();
      return;
    }
    
    // Si no hay datos, abrir modal para elegir tipo de venta
    setMismoNombre(false);
    
    // Inicializar participantes seg√∫n el tipo de venta actual
    if (tipoVenta === 'multiple') {
      const nuevosParticipantes = numerosSeleccionados.map((numero, index) => ({
        id: `temp_${index}`,
        nombre: '',
        telefono: '',
        numeros: [numero]
      }));
      setParticipantesVenta(nuevosParticipantes);
    } else {
      // Venta individual - un participante con todos los n√∫meros
      setParticipantesVenta([{
        id: 'temp_0',
        nombre: '',
        telefono: '',
        numeros: numerosSeleccionados
      }]);
    }
    
    setMostrarModalVenta(true);
  };

  // Funci√≥n para venta directa (sin modal)
  const venderDirecto = async () => {
    if (!nuevoParticipante.nombre.trim()) {
      alert('Por favor, ingresa el nombre del participante.');
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const participanteData = {
        nombre: nuevoParticipante.nombre,
        telefono: nuevoParticipante.telefono || '',
        numerosSeleccionados: numerosSeleccionados
      };

      // Usar el nuevo endpoint de venta directa para administradores
      const response = await fetch(`http://localhost:5001/api/participantes/${rifa.id}/vender`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(participanteData)
      });

      const result = await response.json();
      
      if (response.ok && result.message) {
        // Limpiar formulario
        setNuevoParticipante({ nombre: '', telefono: '', numeros: [] });
        setNumerosSeleccionados([]);
        
        // Recargar datos desde el backend
        await recargarDatosRifa();
        
        const total = parseFloat(rifa.precio) * numerosSeleccionados.length;
        alert(`¬°Venta directa exitosa! Se vendieron ${numerosSeleccionados.length} n√∫meros por $${total}. Los n√∫meros est√°n confirmados autom√°ticamente.`);
      } else {
        alert('Error al procesar la venta: ' + (result.error || 'Error desconocido'));
      }
    } catch (error) {
      console.error('Error vendiendo n√∫meros:', error);
      alert('Error al procesar la venta. Por favor, intenta nuevamente.');
    }
  };

  // Funciones para el modal de venta
  const actualizarParticipante = (index, campo, valor) => {
    const nuevosParticipantes = [...participantesVenta];
    nuevosParticipantes[index][campo] = valor;
    setParticipantesVenta(nuevosParticipantes);
  };

  const aplicarMismoNombre = (nombre) => {
    const nuevosParticipantes = participantesVenta.map(p => ({
      ...p,
      nombre: nombre
    }));
    setParticipantesVenta(nuevosParticipantes);
  };

  const cambiarTipoVenta = (nuevoTipo) => {
    setTipoVenta(nuevoTipo);
    setMismoNombre(false);
    
    // Reorganizar participantes seg√∫n el nuevo tipo
    if (nuevoTipo === 'multiple') {
      const nuevosParticipantes = numerosSeleccionados.map((numero, index) => ({
        id: `temp_${index}`,
        nombre: '',
        telefono: '',
        numeros: [numero]
      }));
      setParticipantesVenta(nuevosParticipantes);
    } else {
      // Venta individual - un participante con todos los n√∫meros
      setParticipantesVenta([{
        id: 'temp_0',
        nombre: '',
        telefono: '',
        numeros: numerosSeleccionados
      }]);
    }
  };

  // Funci√≥n para cargar datos de la rifa desde el backend (carga inicial)
  const cargarDatosRifa = async () => {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`http://localhost:5001/api/rifas/${id}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (response.ok) {
        const result = await response.json();
        const rifaActualizada = result.rifa;
        
        // Extraer n√∫meros vendidos y reservados de los participantes
        const participantes = rifaActualizada.participantes || [];
        const numerosVendidos = [];
        const numerosReservados = [];
        
        participantes.forEach(participante => {
          if (participante.estado === 'confirmado') {
            numerosVendidos.push(...participante.numeros_seleccionados);
          } else if (participante.estado === 'pendiente') {
            numerosReservados.push(...participante.numeros_seleccionados);
          }
        });
        
        // Mapear datos del backend al formato esperado por el frontend
        const rifaCompleta = {
          ...rifaActualizada,
          // Mantener arrays para compatibilidad con el c√≥digo existente
          numerosReservados: numerosReservados,
          numerosVendidos: numerosVendidos,
          participantes: rifaActualizada.participantes || [],
          // Usar elementos disponibles del backend
          numerosDisponibles: obtenerElementosDisponibles(rifaActualizada),
          // Mapear estad√≠sticas num√©ricas del backend
          totalElementosReservados: parseInt(rifaActualizada.estadisticas?.obtener_estadisticas_rifa?.elementos_reservados || 0),
          totalElementosVendidos: parseInt(rifaActualizada.estadisticas?.obtener_estadisticas_rifa?.elementos_vendidos || 0),
          totalParticipantes: parseInt(rifaActualizada.estadisticas?.obtener_estadisticas_rifa?.total_participantes || 0),
          totalRecaudado: parseFloat(rifaActualizada.estadisticas?.obtener_estadisticas_rifa?.total_recaudado || 0)
        };
        
        console.log('RifaManagement - Datos cargados:', {
          elementos_personalizados: rifaCompleta.elementos_personalizados,
          numerosVendidos: rifaCompleta.numerosVendidos,
          numerosReservados: rifaCompleta.numerosReservados,
          participantes: rifaCompleta.participantes
        });
        
        setRifa(rifaCompleta);
        
        // Tambi√©n actualizar en la lista de rifas
        const rifasActualizadas = rifas.map(r => 
          r.id === id ? rifaCompleta : r
        );
        setRifas(rifasActualizadas);
      } else {
        console.error('Error cargando rifa:', response.status, response.statusText);
        setRifa(null);
      }
    } catch (error) {
      console.error('Error cargando datos de la rifa:', error);
      setRifa(null);
    }
  };

  // Funci√≥n para recargar datos de la rifa desde el backend (actualizaci√≥n)
  const recargarDatosRifa = async () => {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`http://localhost:5001/api/rifas/${rifa.id}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (response.ok) {
        const result = await response.json();
        const rifaActualizada = result.rifa;
        
        // Extraer n√∫meros vendidos y reservados de los participantes
        const participantes = rifaActualizada.participantes || [];
        const numerosVendidos = [];
        const numerosReservados = [];
        
        participantes.forEach(participante => {
          if (participante.estado === 'confirmado') {
            numerosVendidos.push(...participante.numeros_seleccionados);
          } else if (participante.estado === 'pendiente') {
            numerosReservados.push(...participante.numeros_seleccionados);
          }
        });
        
        // Mapear datos del backend al formato esperado por el frontend
        const rifaCompleta = {
          ...rifaActualizada,
          // Mantener arrays para compatibilidad con el c√≥digo existente
          numerosReservados: numerosReservados,
          numerosVendidos: numerosVendidos,
          participantes: rifaActualizada.participantes || [],
          // Usar elementos disponibles del backend
          numerosDisponibles: obtenerElementosDisponibles(rifaActualizada),
          // Mapear estad√≠sticas num√©ricas del backend
          totalElementosReservados: parseInt(rifaActualizada.estadisticas?.obtener_estadisticas_rifa?.elementos_reservados || 0),
          totalElementosVendidos: parseInt(rifaActualizada.estadisticas?.obtener_estadisticas_rifa?.elementos_vendidos || 0),
          totalParticipantes: parseInt(rifaActualizada.estadisticas?.obtener_estadisticas_rifa?.total_participantes || 0),
          totalRecaudado: parseFloat(rifaActualizada.estadisticas?.obtener_estadisticas_rifa?.total_recaudado || 0)
        };
        
        setRifa(rifaCompleta);
        
        // Tambi√©n actualizar en la lista de rifas
        const rifasActualizadas = rifas.map(r => 
          r.id === rifa.id ? rifaCompleta : r
        );
        setRifas(rifasActualizadas);
      }
    } catch (error) {
      console.error('Error recargando datos de la rifa:', error);
    }
  };

  const procesarVenta = async () => {
    // Validar que todos los participantes tengan nombre
    const participantesSinNombre = participantesVenta.filter(p => !p.nombre.trim());
    if (participantesSinNombre.length > 0) {
      alert('Todos los participantes deben tener un nombre.');
      return;
    }

    try {
      const token = localStorage.getItem('token');
      let ventasExitosas = 0;
      let totalRecaudado = 0;

      // Procesar cada participante
      for (const participante of participantesVenta) {
        const participanteData = {
          nombre: participante.nombre,
          telefono: participante.telefono || '',
          numerosSeleccionados: participante.numeros,
          estado: 'confirmado'
        };

        const response = await fetch(`http://localhost:5001/api/participantes/${rifa.id}/vender`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(participanteData)
        });

        const result = await response.json();
        
        if (response.ok && result.message) {
          ventasExitosas++;
          totalRecaudado += parseFloat(rifa.precio) * participante.numeros.length;
        } else {
          console.error('Error vendiendo para', participante.nombre, result.error);
        }
      }

      if (ventasExitosas > 0) {
        setNumerosSeleccionados([]);
        setMostrarModalVenta(false);
        
        // Recargar datos desde el backend para obtener informaci√≥n actualizada
        await recargarDatosRifa();
        
        alert(`¬°Venta directa exitosa! Se procesaron ${ventasExitosas} participantes por un total de $${totalRecaudado}. Todos los n√∫meros est√°n confirmados autom√°ticamente.`);
      } else {
        alert('No se pudo procesar ninguna venta. Por favor, intenta nuevamente.');
      }
    } catch (error) {
      console.error('Error procesando venta:', error);
      alert('Error al procesar la venta. Por favor, intenta nuevamente.');
    }
  };

  const descargarQR = () => {
    const link = document.createElement('a');
    link.download = `qr-rifa-${rifa.nombre}.png`;
    link.href = qrCode;
    link.click();
  };

  // Funci√≥n para validar pago (aprobar participaci√≥n)
  const validarPago = (participanteId) => {
    if (!rifa.participantes || !Array.isArray(rifa.participantes)) return;
    
    const participante = rifa.participantes.find(p => p.id === participanteId);
    if (!participante) return;

    const rifaActualizada = {
      ...rifa,
      participantes: rifa.participantes.map(p => 
        p.id === participanteId 
          ? { ...p, estado: 'confirmado', fechaConfirmacion: new Date().toISOString() }
          : p
      ),
      numerosVendidos: [...rifa.numerosVendidos, ...participante.numerosSeleccionados],
      numerosReservados: (rifa.numerosReservados || []).filter(
        numero => !participante.numerosSeleccionados.includes(numero)
      )
    };

    const rifasActualizadas = rifas.map(r => 
      r.id === rifa.id ? rifaActualizada : r
    );

    setRifas(rifasActualizadas);
    setRifa(rifaActualizada);
  };

  // Funci√≥n para rechazar pago (liberar n√∫meros)
  const confirmarVenta = async (participanteId) => {
    if (window.confirm('¬øEst√°s seguro de que quieres confirmar esta venta? Los n√∫meros se marcar√°n como vendidos.')) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:5001/api/participantes/${rifa.id}/confirmar-venta`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ participanteId })
        });

        const result = await response.json();
        
        if (response.ok && result.message) {
          // Recargar datos desde el backend
          await recargarDatosRifa();
          alert('¬°Venta confirmada exitosamente! Los n√∫meros han sido marcados como vendidos.');
        } else {
          alert('Error al confirmar la venta: ' + (result.error || 'Error desconocido'));
        }
      } catch (error) {
        console.error('Error confirmando venta:', error);
        alert('Error al confirmar la venta. Por favor, intenta nuevamente.');
      }
    }
  };

  const rechazarPago = (participanteId) => {
    if (!rifa.participantes || !Array.isArray(rifa.participantes)) return;
    
    const participante = rifa.participantes.find(p => p.id === participanteId);
    if (!participante) return;

    const rifaActualizada = {
      ...rifa,
      participantes: rifa.participantes.filter(p => p.id !== participanteId),
      numerosReservados: (rifa.numerosReservados || []).filter(
        numero => !participante.numerosSeleccionados.includes(numero)
      )
    };

    const rifasActualizadas = rifas.map(r => 
      r.id === rifa.id ? rifaActualizada : r
    );

    setRifas(rifasActualizadas);
    setRifa(rifaActualizada);
  };

  if (!rifa) {
    return (
      <div className="management-container">
        <div className="header-top">
          <Link to="/" className="btn-back-to-rifas">
            ‚Üê Regresar al Dashboard
          </Link>
        </div>
        <h2>Rifa no encontrada</h2>
        <Link to="/" className="btn-primary">Volver al inicio</Link>
      </div>
    );
  }

  return (
    <div className="management-container">
      <div className="header-top">
        <Link to="/" className="btn-back-to-rifas">
          ‚Üê Regresar al Dashboard
        </Link>
      </div>
      <div className="management-header">
        <h2>Gesti√≥n de Rifa: {rifa.nombre}</h2>
        <div className="header-actions">
          <button onClick={recargarDatosRifa} className="btn-secondary">
            üîÑ Actualizar Datos
          </button>
          <Link to="/" className="btn-secondary">‚Üê Volver</Link>
        </div>
      </div>

      <div className="management-content">
        <div className="qr-section">
          <h3>üì± Compartir Rifa</h3>
          <div className="qr-container">
            {qrCode && (
              <>
                <img src={qrCode} alt="QR Code" className="qr-image" />
                <p className="qr-url">{window.location.origin}/public/{rifa.id}</p>
                <button onClick={descargarQR} className="btn-primary">
                  üì• Descargar QR
                </button>
              </>
            )}
          </div>
        </div>

        <div className="venta-section">
          <h3>üé´ Vender N√∫meros</h3>
          <div className="venta-form">
            <div className="form-group">
              <label>Nombre del participante</label>
              <input
                type="text"
                placeholder="Ej: Juan P√©rez"
                value={nuevoParticipante.nombre}
                onChange={(e) => setNuevoParticipante({...nuevoParticipante, nombre: e.target.value})}
              />
            </div>
            <div className="form-group">
              <label>Tel√©fono (opcional)</label>
              <input
                type="tel"
                placeholder="Ej: (555) 123-4567"
                value={nuevoParticipante.telefono}
                onChange={(e) => setNuevoParticipante({...nuevoParticipante, telefono: e.target.value})}
              />
            </div>
            
            <div className="numeros-seleccion">
              <h4>N√∫meros Seleccionados: {numerosSeleccionados.length}</h4>
              <div className="numeros-grid">
                {rifa.elementos_personalizados.map(numero => {
                  const vendido = rifa.numerosVendidos.includes(numero);
                  const reservado = (rifa.numerosReservados || []).includes(numero);
                  const disponible = !vendido && !reservado;
                  
                  return (
                    <button
                      key={numero}
                      className={`numero-btn ${numerosSeleccionados.includes(numero) ? 'seleccionado' : 
                        vendido ? 'vendido' : 
                        reservado ? 'reservado' : 'disponible'}`}
                      onClick={() => disponible && seleccionarNumero(numero)}
                      disabled={!disponible}
                      title={vendido ? 'Vendido' : reservado ? 'Reservado' : 'Disponible'}
                    >
                      {numero}
                    </button>
                  );
                })}
              </div>
            </div>

            <div className="venta-buttons">
              <button 
                onClick={venderNumeros} 
                className="btn-primary"
                disabled={numerosSeleccionados.length === 0}
              >
                Vender N√∫meros (${rifa.precio * numerosSeleccionados.length})
              </button>
              
              <button 
                onClick={() => {
                  setTipoVenta('multiple');
                  venderNumeros();
                }}
                className="btn-secondary"
                disabled={numerosSeleccionados.length === 0}
              >
                Venta M√∫ltiple
              </button>
            </div>
          </div>
        </div>

        <div className="estadisticas-section">
          <h3>üìä Estad√≠sticas</h3>
          <div className="stats-grid">
            <div className="stat-card">
              <h4>Total N√∫meros</h4>
              <p>{rifa.cantidad_elementos || rifa.numerosDisponibles.length}</p>
            </div>
            <div className="stat-card">
              <h4>Vendidos</h4>
              <p>{rifa.totalElementosVendidos || 0}</p>
            </div>
            <div className="stat-card">
              <h4>Disponibles</h4>
              <p>{rifa.estadisticas?.obtener_estadisticas_rifa?.elementos_disponibles || 
                rifa.numerosDisponibles.filter(n => 
                  !rifa.numerosVendidos.includes(n) && 
                  !(rifa.numerosReservados || []).includes(n)
                ).length}</p>
            </div>
            <div className="stat-card">
              <h4>Reservados</h4>
              <p>{rifa.totalElementosReservados || 0}</p>
            </div>
            <div className="stat-card">
              <h4>Participantes</h4>
              <p>{rifa.totalParticipantes || (rifa.participantes ? rifa.participantes.length : 0)}</p>
            </div>
            <div className="stat-card">
              <h4>Recaudado</h4>
              <p>${rifa.totalRecaudado || 0}</p>
            </div>
          </div>
        </div>

        {/* Secci√≥n de Premios */}
        {rifa.premios && rifa.premios.length > 0 && (
          <div className="premios-management">
            <h3>üèÜ Premios de la Rifa</h3>
            <div className="premios-list">
              {rifa.premios.map((premio, index) => (
                <div key={premio.id} className="premio-management">
                  <div className="premio-posicion">
                    {index === 0 && 'ü•á'}
                    {index === 1 && 'ü•à'}
                    {index === 2 && 'ü•â'}
                    {index > 2 && `#${index + 1}`}
                  </div>
                  <div className="premio-info">
                    <h4>{premio.nombre}</h4>
                    {premio.descripcion && <p>{premio.descripcion}</p>}
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Secci√≥n de Fotos */}
        {rifa.fotosPremios && rifa.fotosPremios.length > 0 && (
          <div className="fotos-management">
            <h3>üì∏ Fotos de Premios</h3>
            <div className="fotos-management-grid">
              {rifa.fotosPremios.map(foto => (
                <div key={foto.id} className="foto-management">
                  <img src={foto.url} alt={foto.nombre} />
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Secci√≥n de Reglas */}
        {rifa.reglas && (
          <div className="reglas-management">
            <h3>üìã Reglas de la Rifa</h3>
            <div className="reglas-content">
              <p>{rifa.reglas}</p>
            </div>
          </div>
        )}

        <div className="participantes-section">
          <div className="participantes-header">
            <div className="participantes-title">
              <h3>üë• Participantes</h3>
              {rifa.participantes && rifa.participantes.length > 0 && (
                <div className="participantes-stats">
                  <span className="stat-pendientes">
                    ‚è≥ {rifa.participantes.filter(p => !p.estado || p.estado === 'pendiente').length} pendientes
                  </span>
                  <span className="stat-confirmados">
                    ‚úÖ {rifa.participantes.filter(p => p.estado === 'confirmado').length} confirmados
                  </span>
                </div>
              )}
            </div>
            {rifa.participantes && rifa.participantes.length > 0 && (
              <div className="participantes-controls">
                <Link 
                  to={`/participantes/${rifa.id}`}
                  className="btn-secondary"
                >
                  Ver Todos los Participantes
                </Link>
              </div>
            )}
          </div>
          
          {(!rifa.participantes || rifa.participantes.length === 0) ? (
            <p>No hay participantes a√∫n</p>
          ) : (() => {
            const participantesPendientes = rifa.participantes.filter(p => !p.estado || p.estado === 'pendiente');
            return participantesPendientes.length === 0 ? (
              <p className="no-participantes-message">
                No hay participantes pendientes
              </p>
            ) : (
              <div className="participantes-list">
                {participantesPendientes.map(participante => (
                <div key={participante.id} className="participante-card">
                  <div className="participante-header">
                    <h4>{participante.nombre}</h4>
                    <span className={`estado-participante ${participante.estado || 'pendiente'}`}>
                      {participante.estado === 'confirmado' ? '‚úÖ Confirmado' : '‚è≥ Pendiente'}
                    </span>
                  </div>
                  
                  <div className="participante-info">
                    {participante.telefono && <p>üìû {participante.telefono}</p>}
                    <p>üé´ N√∫meros: {participante.numeros_seleccionados ? participante.numeros_seleccionados.join(', ') : 'No especificados'}</p>
                    <p>üí∞ Total: ${participante.total_pagado || '0'}</p>
                    <p>üìÖ Fecha: {new Date(participante.fecha_participacion).toLocaleDateString()}</p>
                  </div>

                  {(!participante.estado || participante.estado === 'pendiente') && (
                    <div className="participante-actions">
                      <button 
                        className="btn-validar"
                        onClick={() => confirmarVenta(participante.id)}
                        title="Confirmar venta y marcar como vendido"
                      >
                        ‚úÖ Confirmar Venta
                      </button>
                      <button 
                        className="btn-rechazar"
                        onClick={() => rechazarPago(participante.id)}
                        title="Rechazar y liberar n√∫meros"
                      >
                        ‚ùå Rechazar
                      </button>
                    </div>
                  )}
                </div>
                ))}
              </div>
            );
          })()}
        </div>
      </div>

      {/* Modal de Venta */}
      {mostrarModalVenta && (
        <div className="modal-overlay">
          <div className="modal-content venta-modal">
            <div className="modal-header">
              <h2>üéØ Procesar Venta</h2>
              <button 
                className="modal-close"
                onClick={() => setMostrarModalVenta(false)}
              >
                ‚úï
              </button>
            </div>

            <div className="modal-body">
              {/* Tipo de Venta */}
              <div className="form-group">
                <label>Tipo de Venta:</label>
                <div className="tipo-venta-options">
                  <label className="radio-option">
                    <input
                      type="radio"
                      name="tipoVenta"
                      value="individual"
                      checked={tipoVenta === 'individual'}
                      onChange={(e) => cambiarTipoVenta(e.target.value)}
                    />
                    <span>Individual (1 persona, {numerosSeleccionados.length} n√∫meros)</span>
                  </label>
                  <label className="radio-option">
                    <input
                      type="radio"
                      name="tipoVenta"
                      value="multiple"
                      checked={tipoVenta === 'multiple'}
                      onChange={(e) => cambiarTipoVenta(e.target.value)}
                    />
                    <span>M√∫ltiple ({numerosSeleccionados.length} personas, 1 n√∫mero cada uno)</span>
                  </label>
                </div>
              </div>

              {/* Opci√≥n de mismo nombre para venta m√∫ltiple */}
              {tipoVenta === 'multiple' && (
                <div className="form-group">
                  <label className="checkbox-label">
                    <input
                      type="checkbox"
                      checked={mismoNombre}
                      onChange={(e) => setMismoNombre(e.target.checked)}
                    />
                    <span>Usar el mismo nombre para todos</span>
                  </label>
                </div>
              )}

              {/* Campo de nombre global para venta m√∫ltiple con mismo nombre */}
              {tipoVenta === 'multiple' && mismoNombre && (
                <div className="form-group">
                  <label>Nombre para todos los participantes:</label>
                  <input
                    type="text"
                    placeholder="Ej: Familia Garc√≠a"
                    onChange={(e) => aplicarMismoNombre(e.target.value)}
                  />
                </div>
              )}

              {/* Lista de participantes */}
              <div className="participantes-venta">
                <h3>Participantes ({participantesVenta.length})</h3>
                {participantesVenta.map((participante, index) => (
                  <div key={participante.id} className="participante-venta">
                    <div className="participante-header">
                      <span className="participante-numero">#{index + 1}</span>
                      <span className="participante-numeros">
                        N√∫meros: {participante.numeros.join(', ')}
                      </span>
                      <span className="participante-precio">
                        ${parseFloat(rifa.precio) * participante.numeros.length}
                      </span>
                    </div>
                    
                    {!(tipoVenta === 'multiple' && mismoNombre) && (
                      <div className="participante-form">
                        <input
                          type="text"
                          placeholder="Nombre del participante"
                          value={participante.nombre}
                          onChange={(e) => actualizarParticipante(index, 'nombre', e.target.value)}
                        />
                        <input
                          type="text"
                          placeholder="Tel√©fono (opcional)"
                          value={participante.telefono}
                          onChange={(e) => actualizarParticipante(index, 'telefono', e.target.value)}
                        />
                      </div>
                    )}
                  </div>
                ))}
              </div>

              {/* Resumen de la venta */}
              <div className="resumen-venta">
                <h3>Resumen de Venta</h3>
                <div className="resumen-stats">
                  <div className="stat">
                    <span>Total Participantes:</span>
                    <span>{participantesVenta.length}</span>
                  </div>
                  <div className="stat">
                    <span>Total N√∫meros:</span>
                    <span>{numerosSeleccionados.length}</span>
                  </div>
                  <div className="stat total">
                    <span>Total a Cobrar:</span>
                    <span>${parseFloat(rifa.precio) * numerosSeleccionados.length}</span>
                  </div>
                </div>
              </div>
            </div>

            <div className="modal-footer">
              <button 
                className="btn-secondary"
                onClick={() => setMostrarModalVenta(false)}
              >
                Cancelar
              </button>
              <button 
                className="btn-primary"
                onClick={procesarVenta}
              >
                Procesar Venta (${parseFloat(rifa.precio) * numerosSeleccionados.length})
              </button>
            </div>
          </div>
        </div>
      )}

    </div>
  );
};

export default RifaManagement;
